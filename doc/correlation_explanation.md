# 相关性（Correlation）详解

## 1. 什么是相关性？

相关性是衡量两个信号**形状相似程度**的指标。

- 相关系数 = 1.0：两个信号形状完全相同
- 相关系数 = 0：两个信号完全无关
- 相关系数 = -1.0：两个信号形状完全相反

## 2. 数学公式

### 皮尔逊相关系数（Pearson Correlation Coefficient）

$$r = \frac{\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i - \bar{x})^2} \cdot \sqrt{\sum_{i=1}^{n}(y_i - \bar{y})^2}}$$

其中：
- $x_i, y_i$：两个信号的第 i 个采样点
- $\bar{x}, \bar{y}$：两个信号的均值
- $n$：采样点数量

### 简化理解

分子：两个信号"去均值后"的点乘（内积）
分母：两个信号各自的"长度"（模）的乘积

## 3. 相关 vs 卷积

### 相关（Correlation）
$$R_{xy}[k] = \sum_{n} x[n] \cdot y[n+k]$$

- 直接相乘
- 用于测量相似度

### 卷积（Convolution）
$$x * y[k] = \sum_{n} x[n] \cdot y[k-n]$$

- 一个信号翻转后相乘
- 用于系统响应计算

### 区别
- 卷积需要将一个信号**时间翻转**
- 相关不需要翻转
- 对于对称信号，两者结果相同

## 4. 几何解释（重点）

### 把信号当作向量

假设我们有两个信号，每个信号有 N 个采样点：

```
信号 A: [a₁, a₂, a₃, ..., aₙ]
信号 B: [b₁, b₂, b₃, ..., bₙ]
```

我们可以把它们看作 N 维空间中的两个向量。

### 2D 简单例子

假设信号只有 2 个采样点：

```
信号 A: [3, 4]  → 2D 空间中的一个箭头
信号 B: [6, 8]  → 2D 空间中的另一个箭头
```

在坐标系中画出来：

```
        Y
        ^
        |      B(6,8)
        |     /
        |    /
        |   / A(3,4)
        |  /
        | /
        |/
        +---------> X
```

### 向量夹角与相似度

两个向量之间有一个**夹角 θ**：

```
cos(θ) = (A · B) / (|A| × |B|)
```

- **A · B**：点乘（内积）= a₁×b₁ + a₂×b₂ = 3×6 + 4×8 = 50
- **|A|**：向量 A 的长度 = √(3² + 4²) = 5
- **|B|**：向量 B 的长度 = √(6² + 8²) = 10

所以：
```
cos(θ) = 50 / (5 × 10) = 1.0
```

cos(θ) = 1.0 意味着 θ = 0°，两个向量**方向完全相同**！

### 关键洞察

**相关系数 = 去均值后向量的夹角余弦**

| cos(θ) 值 | 夹角 θ | 含义 |
|-----------|--------|------|
| 1.0 | 0° | 方向完全相同 |
| 0.0 | 90° | 完全垂直（无关） |
| -1.0 | 180° | 方向完全相反 |

## 5. 高维空间（IQ 信号）

### 为什么可以扩展到高维？

IQ 信号通常有成千上万个采样点。比如 1856 个采样点。

虽然我们无法"看到" 1856 维空间，但数学公式是**完全一样的**：

```python
# 2D 空间
cos(θ) = (x₁×y₁ + x₂×y₂) / (|X| × |Y|)

# 1856D 空间
cos(θ) = (x₁×y₁ + x₂×y₂ + ... + x₁₈₅₆×y₁₈₅₆) / (|X| × |Y|)
```

### 直觉理解

想象一下：
- 每个采样点是一个"维度"
- 信号是这个高维空间中的一个"箭头"
- 相关系数测量两个箭头之间的"夹角"

即使在 1856 维空间中，"夹角"的概念依然有效：
- 夹角 = 0°：两个信号指向同一方向（形状相同）
- 夹角 = 90°：两个信号垂直（完全无关）

## 6. 为什么幅度不影响相关性？

### 向量的方向 vs 长度

```
A = [3, 4]      长度 = 5
B = [6, 8]      长度 = 10
C = [30, 40]    长度 = 50
```

虽然 A、B、C 长度不同，但它们**方向相同**（都在同一条直线上）。

相关系数只关心**方向**，不关心**长度**。

### 对 IQ 信号的意义

```
原始信号:     [-0.5, 0.8, -0.3, ...]     范围: -1 ~ 1
量化后信号:   [-1024, 1638, -614, ...]   范围: -2048 ~ 2047
```

虽然数值完全不同（幅度放大了约 2000 倍），但：
- 形状完全相同
- 在高维空间中方向相同
- 相关系数 = 1.0

## 7. 实际应用

### 在 BLE Studio 中验证数据完整性

```python
import numpy as np

def calculate_correlation(signal1, signal2):
    """计算两个信号的相关系数"""
    # 分离实部和虚部
    x = np.concatenate([signal1.real, signal1.imag])
    y = np.concatenate([signal2.real, signal2.imag])

    # 去均值
    x = x - np.mean(x)
    y = y - np.mean(y)

    # 计算相关系数
    correlation = np.dot(x, y) / (np.linalg.norm(x) * np.linalg.norm(y))

    return correlation
```

### 验证导出/导入数据

```python
# 原始信号
original = modulator.modulate(packet)

# 导出到文件
exporter.export_txt(original, "iq_data.txt")

# 从文件导入
imported = importer.import_txt("iq_data.txt")

# 验证
r = calculate_correlation(original, imported)
print(f"相关系数: {r:.6f}")  # 应该接近 1.0
```

## 8. 总结

| 概念 | 说明 |
|------|------|
| 相关系数 | 衡量两个信号形状的相似度 |
| 取值范围 | -1 到 +1 |
| 几何意义 | 高维空间中向量夹角的余弦值 |
| 关键特性 | 只关心形状（方向），不关心幅度（长度） |
| 实际应用 | 验证 IQ 数据导出/导入的正确性 |

### 一句话总结

**相关系数 = 把信号当作高维空间中的箭头，测量它们之间的夹角。夹角为 0° 时相关系数为 1，表示形状完全相同。**
